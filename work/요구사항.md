
# 1) 목표(Objectives)

- 전표 생성 로직의 **규칙화/설정화**(하드코딩 제거, TRSxxxx 등 제거)
    
- **실시간 계산**과 **사전 생성(미리 터뜨리기)** 전략 중 선택/혼합이 가능하도록 구조화
    
- **평가영역(예: IFRS/K-GAAP/US GAAP 등) 멀티 레저** 동시 지원
    
- **외화/원화 동시 전표(듀얼 통화)** 및 **자산/손익 집계 일관성** 확보
    
- **결제/승인/취소 전표** 연동 가능 구조(워크플로우 훅)
    
- **잔액 대사/밸리데이션** 체계 정착(보유원장·손익집계 일치)
    
- **성능**(기간 대량 조회/집계)과 **이력성/감사 추적** 강화
    

# 2) 범위(Scope)

- 대상 화면: 회계 관리의 “자산별 전표 발의”/“손익 집계” 중심 (잔액대사 보강 포함)
    
- 대상 도메인: 포지션 이벤트 → 전표 규칙 매핑 → 전표 헤더/라인 생성 → 확정/전송/취소
    
- 제외: 외부 회계시스템 자체, 회사 고유 결재시스템(단, 인터페이스/훅 제공)
    

# 3) 핵심 개념/용어(Domain)

- **포지션 처리 유형(Position Event Type, 갱신유형)**: 거래/평가/이자/세금 등 이벤트 최소 단위
    
- **전표 규칙(JE Rule)**: 이벤트→차/대 계정, 금액 항목 매핑(포스팅 여부 포함)
    
- **회계 처리 식별자(Accounting Identifier)**: 상품/분류/회계관리그룹 등 속성 조합으로 CoA 선택
    
- **계정과목표(CoA Set)**: 여러 표(예: 로컬, 그룹, 보고용) 병행 지원
    
- **평가영역(Valuation Area)**: IFRS/현지기준/US GAAP 등 병행·단일 선택
    
- **금액 타입(Amount Type)**: 수수료/세금/이자/분배금 등 세분화된 항목 키(하드코딩 금지, 테이블화)
    
- **네팅(Netting)**: 결제/보고 목적의 라인 합산/상계
    

# 4) 기능 요구사항(Functional)

## 4.1 규칙/설정

- [F-01] **전표 규칙 리포지토리**: 포지션 처리 유형 ↔ 전표 규칙 매핑(포스팅 여부, 차/대 구조, 금액타입 집계, 평가영역별 분기)
    
- [F-02] **회계 처리 식별자 결정 엔진**: (상품유형, 유가증권분류, 채권분류, 거래유형, 회계관리그룹 등) → CoA/배정기호/손익분류 결정
    
- [F-03] **계정과목표 멀티셋**: 로컬/그룹/보고별 CoA 세트 운영 및 **동일 이벤트에 다중 전표(평가영역/CoA세트별)** 발생 가능
    
- [F-04] **금액 타입 카탈로그**: 분배금/수수료/세금 등 금액 항목 타입을 설정으로 관리(가중/분해/라운딩 규칙 포함)
    
- [F-05] **통화 정책**: 원화 단일/원화+외화 듀얼 전표 선택(회사별 정책)
    

## 4.2 전표 생성/처리

- [F-06] **실시간 생성 모드**와 **사전 생성(배치/이벤트 시 전개) 모드** 지원(혼용 가능, 버전 관리)
    
- [F-07] **전표 헤더/라인 모델**: 한 이벤트가 여러 라인 생성, 헤더-라인 묶음, **버스트랜스ID/포지션거래번호**로 추적
    
- [F-08] **네팅 규칙**: 결제/결산 기준으로 라인 네팅(통화별, 계좌별, 카운터파티별, 상품그룹별 등 조건식 구성)
    
- [F-09] **결산 전표 특화**: 월말 결산 시 상품군/계정군 단위 집계, 손익 상계(이익/손실 합산) 옵션
    
- [F-10] **취소 전표/재전송**: 원전표 참조 마이너스 전표 생성 및 재기표 플로우(외부 시스템 정책 반영)
    
- [F-11] **평가영역 다중 터짐**: TRDT(단일)/TRLT(다중)류 시나리오 대응, 기본 회계규칙(001)과 추가 규칙 병행
    
- [F-12] **결제/승인 워크플로우 훅**: 확정→전송 전/후, 반려, 다단계 승인 포인트를 **훅/웹훅**으로 제공
    
- [F-13] **외부 인터페이스 어댑터**: 회계시스템별 전문 포맷 매핑(설정 기반 필드 맵), 전송 이력·상태 저장
    

## 4.3 조회/사용자 흐름

- [F-14] **조회 조건 통합**: 포지션·거래·식별자·평가영역·CoA세트·기간·상태(확정/전송/취소) 등
    
- [F-15] **상세 패널**: 헤더/라인·원천 이벤트·금액 분해(금액타입별)·식별자 결정 근거(룰 트레이스)
    
- [F-16] **수정/정정 가이드라인**: 계좌/거래상대 등 보조정보는 **키 기반 조회/지연 결합**으로 뷰에 합성(원장 데이터는 불변)
    
- [F-17] **네팅 작업 UI**: 묶음/해제/규칙 미리보기, 결제 계좌/카운터파티 기준 옵션
    
- [F-18] **감사 로그**: 규칙 버전, 사용자 조작(확정/네팅/취소) 전과 후 스냅샷
    

## 4.4 검증/대사

- [F-19] **보유원장 대사**: 자산계정 누적 = 포지션 장부가(포지션별/상품군별)
    
- [F-20] **손익 집계 일치**: 손익 라인(차/대 부호 규칙) 합계 = 손익집계 화면 값
    
- [F-21] **잔액 대사(계정잔액 vs 우리 잔액)**: 현재 미작동 영역 복구·자동화(오류 탐지/리포트)
    
- [F-22] **밸리데이션 규칙**: AR/AP/자산/손익 계정군별 교차검증(필수 보조정보 유효성 포함)
    

# 5) 비기능 요구사항(Non-Functional)

- [N-01] **성능**: 월 단위(수십만 라인 가정) 조회 ≤ X초, 생성 배치 시간 SLA
    
- [N-02] **일관성**: 이벤트→전표 생성 **결정성**(같은 입력=같은 출력), 규칙 버전 고정
    
- [N-03] **감사/추적성**: 모든 계산 경로/룰버전/입력값 저장, 리플레이 가능
    
- [N-04] **확장성**: 새 평가영역/CoA세트/외부포맷 추가를 설정만으로 온보딩
    
- [N-05] **테스트성**: 규칙 단위 테스트, 시나리오 테스트(거래/평가/결산/취소/네팅)
    
- [N-06] **마이그레이션 친화**: 기본규칙(001)로 전개 후 평가영역 추가 전개 시뮬레이션 지원
    

# 6) 데이터/설계(초안)

## 6.1 주요 테이블

- `coa_set`(CoA 세트), `account`(계정과목), `account_group`(자산/손익/AR/AP 속성)
    
- `amount_type`(수수료/세금/이자 등), `valuation_area`(IFRS/K-GAAP/US GAAP)
    
- `acct_identifier`(회계 처리 식별자; 속성 조합/우선순위/유효기간/버전)
    
- `je_rule`(전표 규칙 헤더: 이벤트/평가영역/CoA세트/포스팅 여부)
    
- `je_rule_line`(차/대 계정, 금액타입, 부호/차대, 집계 키)
    
- `event_fact`(포지션 이벤트 원천; 버스트랜스ID, 금액타입별 세부 금액)
    
- `je_header`, `je_line`(전표 결과), `je_bundle`(네팅 묶음), `je_tx`(전송 이력/상태)
    
- `recon_ledger`(대사 스냅샷), `audit_log`(규칙/사용자/계산 경로)
    

## 6.2 서비스/모듈

- **Identifier Resolver**: 이벤트→회계 식별자 결정
    
- **Posting Engine**: 규칙 적용, 라인 산출, 차/대/부호/라운딩
    
- **Netting Service**: 규칙 기반/수동 네팅
    
- **Valuation Multiplexer**: 평가영역/CoA 세트 별 다중 전개
    
- **Interface Adapter**: 시스템별 포맷 변환/전송
    
- **Reconciliation**: 원장·손익·잔액 대사
    
- **Rule Admin UI**: 룰/CoA/금액타입/식별자 관리, 버전/유효기간
    

# 7) 계산 규칙(핵심 로직)

- **차/대 부호 체계 통일**: 자산/부채/손익 계정군별 플러스/마이너스 정의 표준화
    
- **평가영역 병행**: 동일 이벤트에 대해 기본(001)+추가 평가영역 병렬 전개
    
- **외화 처리**: 원화/외화 동시 라인(환율 소스·시점 설정), 통화별 네팅
    
- **라운딩/배분**: 금액타입 간 분배/세금 분해(국가/상품/거래유형에 따른 규칙)
    

# 8) 사용자 플로우(초안)

1. 조건 조회 → 리스트
    
2. 항목 선택 → 상세(룰 결정 근거, 금액타입 분해)
    
3. (선택) 네팅 구성/미리보기 → 확정
    
4. 전송(동기/비동기) → 전송결과/오류 리포트
    
5. (필요 시) 취소 전표 생성 → 재전송
    
6. 월말 결산 모드 → 집계/상계/전송
    
7. 대사 리포트 확인 → 이슈 추적
    

# 9) 인터페이스/연동

- **전송 방식**: API/파일/메시지 큐 선택(사이트별 어댑터)
    
- **전송 정책**: 스케줄/수동 버튼/상태 재전송/부분 재처리
    
- **키 전달**: 원천 거래 식별 키 포함(타 시스템 상세화면 딥링크 가능)
    

# 10) 거버넌스/버전/릴리즈

- **룰 버전/유효기간**(개정/시행일 관리, 과거 재계산 가능)
    
- **다중 환경/사이트 커스터마이징**: 공통 룰 + 사이트 오버레이(설정 계층화)
    
- **변경 영향 분석**: 룰 변경 시 시뮬레이션/디프/차이 리포트
    

# 11) 마이그레이션 전략

- 1단계: **As-Is 유지 + 신규 엔진 병행(Two-track)** — 이벤트를 기본규칙(001)으로 전개, 결과 비교 리포트
    
- 2단계: 평가영역/CoA 세트 확장 적용, 하드코딩 제거(금액타입/식별자/룰로 치환)
    
- 3단계: 결제/승인 훅 연결, 네팅/결산 고도화, 잔액대사 완전 자동화
    

# 12) 수용 기준(Acceptance)

- 동일 입력(이벤트·평가영역·룰버전) → **결정적 동일 출력**
    
- 보유원장/손익집계 **자동 대사 100%**(허용 오차·라운딩 범위 내)
    
- 대량 기간 조회/전개 **SLA 충족**
    
- 취소 전표/재전송 **엔드투엔드 시나리오** 통과
    
- 하드코딩 항목 **0건**(룰/설정으로 대체)
    

# 13) 열려있는 의사결정(Decision Points)

- 실시간 vs 사전생성 기본 모드(혹은 하이브리드)
    
- 외화 듀얼 전표 기본 적용 여부
    
- 네팅 기본 축(계좌/카운터파티/상품군/통화) 표준안
    
- 결제/승인 워크플로우 연동 수준(단순 훅 vs 단계형 승인 캐시)
    
- 룰 엔진 형태(테이블 기반 DSL vs 룰엔진 도입)